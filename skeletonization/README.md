# Skeletonization

This folder contains the codes for skeletonization of the target neurons in our dataset, which was required for our research[^1].

For the most part, we applied the TEASAR algorithm[^2] to the segmentations of target neurons, which are identified by the voxels with unique ids in our segmentation volume, to extract skeletons. Segmentation volumes were prepared in `hdf5` format, generated by stitching the AI-produced supervoxels according to human proofreadings (see the `reconstruction` folder). 

Control parameters in the TEASAR algorithm other than the parameters `p_scale` and `p_const` which are related to the radius of adaptive sphere are fixed, as written in `dijkstra_root2all.cpp`. Parameters `p_scale` and `p_const` are adjusted to appropriate values according to the type of the neurons.

We note that additional data might be needed for reproduction of our result, especially for the skeletonization of Purkinje cells. Due to the complexity of their structures, skeletonzation of Purkinje cells involved elaborate steps to generate proper and precise skeletons, referring to additional data such as the proofreading task informations or affinity map for boundary detection[^3].

Since each type of neuron has distinct structure, skeletonization process largely differs from type to type. We briefly introduce the skeletonization process and relevant codes below.

## Skeletonization of Purkinje Cells
Cerebellar purkinje cells have complex morphology which is featured by the substructures characterized by different scales, dendritic shaft and spines. Since the spines frequently made self-touches with another in our image, spines should be separated from dendritic shaft prior to skeletonzation; otherwise they form false routes between dendritic branches. Then we skeletonize the shaft and spines separately.

### Volume preparation
relevant codes: `cut_cells_by_task_isotropic.m`,`upscale_volume_of_target_cells.m`

#### separation of cell body from dendrite / isotropic downsampling
First, we prepare the segmentation of the target Purkinje cells ready for shaft-spine separation.
Cell bodies are different in their scale from dendrites, so it is beneficial if we separate them prior to further processing.

Since our shaft-spine separation process utilize morphological operations on the neuronal segments[^4], it works better in isotropic volumes. 
But our original image is anisotropic: each voxel has size of `12nm, 12nm, 50nm` in `x, y, z` directions.
We generated `isotropic mip2` volume downsampled from the original volume in xy directions by factor of `4`, while we also separate the cell body of purkinje cells from dendrite based on proofreading tasks and assign new ids different from the ids of dendrites. (`cut_cells_by_task_isotropic.m`).

This procedure can be replaced by the manual masking of cell bodies and proper downsampling process.

#### upscaling
We found that we have more option for choosing the size of structural elements of morphological operations if we work on mip1 volume. We resized the volume to `mip1` scale, by doubling voxels in every direction using `nearest` method[^5].

### Shaft-spine separation
relevant codes: `separate_pc_shaft_and_spine.m`

After separating cell bodies of Purkinje cells from dendrites and resizing the segmentation volume to `mip1` scale, we separate dendritic spines from shafts making use of morphological operations[^4]. This process results in the isotropic mip1 volumes containing target Purkinje cell with their dendrites and spines are separated, ready for skeletonization of dendritic shafts.

### Shaft skeletonization
relevant codes: `iterate_pc_shaft_skeletonization.m`, `skeletonize_pc_shaft_components_recursively.m`

The shaft part of each Purkinje cell undergoes TEASAR skeletonization. Shaft-spine separation process caused disconnection of dendritic shaft into several connected components. Thus, we apply TEASAR algorithm separately to each connected component and merge them to a single tree-structured skeleton. 

Merging process involves lookup for subvolumes at the disconnected positions which are identified by proofreading task. This procedure can be replaced by manual merging of compartmented skeletons based on visual inspection of the target Purkinje cell.

### Spine segmentation
relevant codes: `iterate_segment_spines_on_pcs.m`, `segment_spines.m`

Since the spines of mouse cerebellar Purkinje cells frequently made contacts with another in our reconstruction, there are connected components cosist of multiple spines after separation of spines from dendritic shaft. We separate then and identify as single spines, based on boundary detection[^3] data once utilized in `reconstruction` process.

### Spine skeletonization
relevant codes: `auto_repeat_spine_skel.m`, `auto_repeat_spine_skeletonization.sh`, `skeletonize_spine_to_the_given_root.m`, `iterate_trace_route_from_spine_root_to_shaft_skeleton.m`,
`trace_route_from_spine_root_to_shaft_skeleton.m`

#### skeletonization of spine components
We generate skeletons for each spine component. Spine skeletons are rooted on the midpoint of the interface to the shaft, and proceed to the tip of the spines. For some spine components which are multi-headed, each spine head is assigned with a branch in the skeleton. (`auto_repeat_spine_skel.m`, `auto_repeat_spine_skeletonization.sh`, `skeletonize_spine_to_the_given_root.m`)

#### trace route between spine skeletons and the shaft skeleton
And then, we connect the skeleton of spines to the proper position of shaft skeleton, completing the skeletonization of the Purkinje cell as a whole (`iterate_trace_route_from_spine_root_to_shaft_skeleton.m`,
`trace_route_from_spine_root_to_shaft_skeleton.m`).

## Skeletonization of Interneurons
relevant codes: `cut_cells_by_task_isotropic.m`,`cut_interneuron_cellbody_by_bbox.m`,
`get_interneuron_dend_skeleton.m`, `make_int_dend_skeleton.m`, `get_interneuron_axon_skeleton.m`, `script_axon_skeleton_maker.m`

### separation of segments into subparts
Interneuron segments are separated into dendrite, axon, and cell body. Separation of axons are proofreading task-based(`cut_cells_by_task_isotropic.m`) and the cell bodies were masked by manually set bounding boxes (`cut_interneuron_cellbody_by_bbox.m`).

### skeletonization of interneuron dendrite
Dendritic branches of interneuron are sprout from several points on the cell body in radial manner, so the skeletonization of interneuron dendrite is applied on the merged component of dendrite and cell body (`get_interneuron_dend_skeleton.m`, `make_int_dend_skeleton.m`). We avoided the generation of branches for non-dendrite protrusions of interneurons by excluding the cell body voxels from the choice of skeleton endpoints.

### skeletonization of interneuron axon
Interneuron axon components are skeletonized by TEASAR algorithm (`get_interneuron_axon_skeleton.m`, `script_axon_skeleton_maker.m`). Since the axonal segments of interneurons in our reconstruction have self-touches showing loop-like structures, there are some errors in automatically generated skeletons of axons: sometimes they falsely break into different branches or merge at false positions. These errors were corrected manually based on visual inspection before analysis.

## Skeletonization of Climbing Fibers
relevant codes: `get_cf_skeleton.m`, `iterate_cf_ids_for_cf_skeletonization.m`

Climbing fibers were skeletonized by direct application of TEASAR algorithm to reconstructed segments of climbing fibers.

## Skeletonization of Parallel Fibers
relevant codes: `getParallelFiberSkeleton.m`, `skeletonize_pf_teasar.m`

Parallel fibers were skeletonized by direct application of TEASAR algorithm to reconstructed segments of parallel fibers.

[^1]: reference of the paper

[^2]: [M. Sato, I. Bitter, M. A. Bender, A. E. Kaufman and M. Nakajima, "TEASAR: tree-structure extraction algorithm for accurate and robust skeletons," Proceedings the Eighth Pacific Conference on Computer Graphics and Applications, Hong Kong, China, 2000, pp. 281-449, doi: 10.1109/PCCGA.2000.883951](https://doi.org/10.1109/PCCGA.2000.883951).

[^3]: [Turaga SC, Murray JF, Jain V, Roth F, Helmstaedter M, Briggman K, Denk W, Seung HS. Convolutional networks can learn to generate affinity graphs for image segmentation. Neural Comput. 2010 Feb;22(2):511-38. doi: 10.1162/neco.2009.10-08-881. PMID: 19922289.](https://doi.org/10.1162/neco.2009.10-08-881)

[^4]: [MATLAB Documentations - Morhpological Operations](https://www.mathworks.com/help/images/morphological-filtering.html?s_tid=CRUX_lftnav)

[^5]: [MATLAB Documentations - imresize3](https://www.mathworks.com/help/images/ref/imresize3.html)
